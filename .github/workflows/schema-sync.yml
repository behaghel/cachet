name: Schema Sync

on:
  schedule:
    # Run daily at 2 AM UTC to check for schema drift
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      force_sync:
        description: "Force regenerate all models"
        required: false
        default: "false"
        type: boolean

env:
  GO_VERSION: "1.21"
  JAVA_VERSION: "17"

jobs:
  schema-drift-check:
    name: 🔍 Schema Drift Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install devenv
        uses: cachix/devenv-action@v1

      - name: Check for schema drift
        id: drift
        run: |
          echo "🔍 Checking for schema drift..."

          # Generate fresh models
          devenv shell -- schema:generate

          # Check if anything changed
          if ! git diff --exit-code generated/ > /dev/null 2>&1; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "❌ Schema drift detected!"
            
            # Show what changed
            echo "## Changed Files:" >> drift_report.md
            git diff --name-only generated/ >> drift_report.md
            echo "" >> drift_report.md
            echo "## Diff:" >> drift_report.md
            git diff generated/ >> drift_report.md
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "✅ No schema drift detected."
          fi

      - name: Create PR for schema sync
        if: steps.drift.outputs.drift_detected == 'true' || github.event.inputs.force_sync == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync generated models with schema"
          title: "🔄 Auto-sync: Generated models update"
          body: |
            ## 🤖 Automated Schema Sync

            This PR was automatically generated to sync the generated models with the current OpenAPI schema.

            ### Changes
            - Updated Go models in `generated/go/`
            - Updated Kotlin models in `generated/kotlin/`

            ### Validation
            - [ ] Schema validation passed
            - [ ] Generated code compiles
            - [ ] Tests pass

            This PR will be automatically merged if all checks pass.
          branch: auto-sync/schema-models
          delete-branch: true

      - name: Auto-approve and merge
        if: steps.drift.outputs.drift_detected == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Wait a moment for PR to be created
          sleep 5

          # Get PR number
          PR_NUMBER=$(gh pr list --head auto-sync/schema-models --json number --jq '.[0].number')

          if [ ! -z "$PR_NUMBER" ]; then
            echo "Auto-approving PR #$PR_NUMBER"
            gh pr review $PR_NUMBER --approve --body "✅ Auto-approved: Schema sync changes look good!"
            
            # Enable auto-merge
            gh pr merge $PR_NUMBER --auto --squash
          fi

  validate-generated-models:
    name: 🧪 Validate Generated Models
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install devenv
        uses: cachix/devenv-action@v1

      - name: Comprehensive model validation
        run: |
          echo "🔧 Generating models..."
          devenv shell -- schema:generate

          echo "📋 Running comprehensive validation..."
          devenv shell -- schema:test

          echo "🧪 Testing Go models..."
          cd generated/go && go mod init temp && go mod tidy && go build .

          echo "📱 Testing Kotlin models..."
          # Check Kotlin compilation in temporary project
          mkdir -p /tmp/kotlin-test/src/main/kotlin
          cp -r generated/kotlin/src/main/kotlin/* /tmp/kotlin-test/src/main/kotlin/

          echo "✅ All models validated successfully!"
